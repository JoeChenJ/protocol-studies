# 客观性与主观性：区块链同步中的弱主观性

## 背景

在信息论和区块链的语境下，我们需要区分“客观性”和“主观性”。如果一条信息的**正确性可以被完全验证**，那么它是**客观的**；如果它的正确性无法被**完全验证**（即某种程度上依赖于信任或共识），那么它就是**主观的**。实际上，大多数信息都处于客观性与主观性的光谱之间。

例如，在以太坊合并（The Merge）之前，如果一个客户端从创世区块开始同步，它可以**客观地**验证其后的每一个区块。具体来说，客户端会向其对等节点请求最新的“最终确定”（Final）区块，并沿着区块的**父哈希**（Parent Hash）一路回溯到创世区块（Genesis），从而验证整个历史数据。当客户端成功回溯至创世区块时，它就可以认定整个历史**正确**，并标记自身为***已同步（synced）***。

> 目前存在不同的同步机制，这里描述的是“完整同步”（Full Sync）的基本流程。

在合并之前，想要篡改区块链的历史需要**巨大的算力**（工作量证明，Proof-of-Work），因此被验证过的历史数据（在 PoW 时代）是**客观的**。不过，创世区块的正确性仍然依赖于某种程度的信任，但由于大多数客户端都自带创世区块及其校验和（Checksum），所以可以认为它是**弱客观的（Weakly Objective）**，而非完全主观的。

> 早期，以太坊中的“最终确定”区块通常指**倒数第 7 个区块**，因为重组 6 个区块的 PoW 计算量极大，几乎不可行。

在合并后，以太坊引入了**验证者（Validator）机制**和**投票机制**，并且**共识机制**被从**历史和执行机制**中逻辑上隔离，即**共识层（Consensus Layer, CL）** 和 **执行层（Execution Layer, EL）**。虽然历史数据的同步方式基本保持不变，但用于同步的最新“最终确定”区块则来自共识层。同时，执行层负责验证区块的执行正确性（例如智能合约的运行结果），然后共识层对区块进行投票并达成共识。然而，由于共识机制的变化，使得**创世区块同步变得“不安全”**（[参考资料](https://docs.teku.consensys.io/concepts/weak-subjectivity#sync-outside-the-weak-subjectivity-period)）。* 这就引出了弱主观性（Weak Subjectivity）。*

> 新的共识机制带来了许多复杂的变化，理解这些变化对于理解弱主观性至关重要。推荐阅读：[以太坊信标链概述](https://ethos.dev/beacon-chain)。

---

## 弱主观性下的同步机制

在以太坊权益证明（Proof-of-Stake, PoS）机制下，当一个验证者**退出网络**，它的**共识投票权**会被撤销，这意味着它不能再为未来的区块投票或进行证明（Attestation）。但**该验证者仍然可以对过去的区块重新投票/证明**。如果足够多的已退出验证者对某个**过去的区块**（即某个分叉的历史区块）重新投票，他们就可能形成一个**替代历史**（Alternative History）。

- **对于一个已经完成同步（Synced）的节点**，它已经处理过这些验证者的退出，因此它不会受到影响。
- **但对于正在同步（Syncing）的新节点**，它无法判断这些验证者的状态，从而可能错误地同步到错误的链上。

为了防止这一问题，以太坊信标链（Beacon Chain）采用了一种**反向同步**（Backfill Syncing）方式，这是信标链同步与执行层同步的第一个主要区别。

### 1. **同步目标的主观性**
由于以太坊的链历史在某些条件下是可以被改变的，因此**同步目标（Sync Target）无法被完全客观地验证**，即它的**存在性不能被严格证明**。因此，信任在同步过程中起着关键作用，使得同步目标**带有主观性**。

为了提高安全性，**同步目标（称为弱主观性检查点，Weak Subjectivity Checkpoint）不会通过 p2p 网络随意传播，而是通过“带外渠道”（Out-of-Band）获取**。由于它是一个**最终确定的（Finalized）检查点**，它仍然具有一定的**弱客观性**——换句话说，我们可以在一定程度上验证它的正确性，但无法验证它的**存在性**。

### 2. **弱主观性周期**
如果一个节点长时间未同步，它同样可能受到类似的攻击。理论上，如果**足够多的验证者**在这段时间内**退出**并且重新投票，那么它们就可以创建一个伪造的历史。这段时间被称为 **“弱主观性周期”（Weak Subjectivity Period）**。

这个周期同样适用于同步目标。如果一个节点同步的速度过慢（例如执行层的同步耗时过长），那么同步目标就会变得**过时（Stale）**，从而带来安全风险。

因此，在同步执行层时，新的信标区块会被**乐观地（Optimistically）导入**，但不会立即验证其执行有效性，直到同步完成后再进行验证。这种机制称为 **“乐观同步”（Optimistic Syncing）**。

---

## 弱主观性同步流程

基于以上分析，**弱主观性同步**流程如下：

1. **通过带外渠道获取一个弱主观性检查点**
2. **从该检查点反向回溯区块，直至创世区块**
3. **更新执行链的目标头部（Target Header）**
4. **乐观地跟随链的最新头部，并持续更新执行链的目标头部**
5. **执行层完成同步后，验证共识层的区块并将其标记为已验证，节点才可视为完全同步**

---

## 参考资料

1. [Prysm 客户端：乐观同步](https://docs.prylabs.network/docs/how-prysm-works/optimistic-sync)
2. [以太坊官方文档：弱主观性](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/weak-subjectivity/)
3. [以太坊 2.0 的弱主观性周期](https://www.symphonious.net/2019/11/27/exploring-ethereum-2-weak-subjectivity-period/)
4. [Vitalik Buterin：权益证明与弱主观性](https://blog.ethereum.org/2014/11/25/proof-stake-learned-love-weak-subjectivity)
5. [以太坊 2.0 的弱主观性解析](https://notes.ethereum.org/@adiasg/weak-subjectvity-eth2)
6. [以太坊博客：最终性概述](https://blog.ethereum.org/2016/05/09/on-settlement-finality)

